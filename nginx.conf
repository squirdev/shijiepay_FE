server {
    listen 80;
    server_name pay4.rd789.com;

    set $deploy_root /www/pay4world/pay4world/dist/current;

    # 1. 根路径跳转
    location = / {
        return 301 /pay4Mgr/;
    }

    # 2. 兼容无斜杠访问
    location = /pay4Mgr {
        return 301 /pay4Mgr/;
    }

    # ==================================================
    # version.json 强制不缓存
    # 确保前端轮询时每次都能拿到服务器最新的版本号
    # ==================================================
    location ~* ^/pay4Mgr/version\.json$ {
        root $deploy_root;
        add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0";
        add_header Pragma "no-cache";
        expires 0;
        access_log off; # 轮询日志太多，建议关闭
    }

    # 3. index.html 禁缓存（SPA 入口必需）
    location = /pay4Mgr/index.html {
        root $deploy_root;
        try_files /pay4Mgr/index.html =404;

        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
        add_header Pragma "no-cache";
        add_header Expires 0;
    }

    # 4. 静态资源强缓存 (注意：已移除 json 后缀)
    # 只有带 hash 的文件名才适合 immutable 强缓存
    location ~* ^/pay4Mgr/.+\.(js|css|png|jpg|jpeg|gif|svg|webp|ico|woff|woff2)$ {
        root $deploy_root;
        add_header Cache-Control "public, max-age=604800, immutable";
        try_files $uri =404;
    }

    # 5. Vue SPA 主应用兜底
    location /pay4Mgr/ {
        root $deploy_root;
        try_files $uri $uri/ /pay4Mgr/index.html;
    }

    # 6. favicon
    location = /favicon.ico {
        root $deploy_root/pay4Mgr;
        log_not_found off;
        access_log off;
    }
}

server {
    listen 80;
    server_name mch.rd789.com;

    set $deploy_root /www/pay4world/pay4world/dist/current;

    location = / {
        return 301 /pay4Mch/;
    }

    location = /pay4Mch {
        return 301 /pay4Mch/;
    }

    # ==================================================
    # version.json 强制不缓存
    # ==================================================
    location ~* ^/pay4Mch/version\.json$ {
        root $deploy_root;
        add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0";
        add_header Pragma "no-cache";
        expires 0;
        access_log off;
    }

    # index.html 禁缓存
    location = /pay4Mch/index.html {
        root $deploy_root;
        try_files /pay4Mch/index.html =404;

        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
        add_header Pragma "no-cache";
        add_header Expires 0;
    }

    # 静态资源强缓存
    location ~* ^/pay4Mch/.+\.(js|css|png|jpg|jpeg|gif|svg|webp|ico|woff|woff2)$ {
        root $deploy_root;
        add_header Cache-Control "public, max-age=604800, immutable";
        try_files $uri =404;
    }

    # Vue SPA 主应用
    location /pay4Mch/ {
        root $deploy_root;
        try_files $uri $uri/ /pay4Mch/index.html;
    }

    location = /favicon.ico {
        root $deploy_root/pay4Mch;
        log_not_found off;
        access_log off;
    }
}

